@page "/hub"
@inherits AuthenticatedComponent

@inject ICategoryService CatSrv
@inject IProductService ProdSrv
@inject IMailingService MailSrv
@inject IAdminService AdminSrv

@inject NavigationManager NavMgr

<section class="hero is-halfheight" style="background-image: url(/img/stonks.png); background-size: cover;">
  <div class="hero-body">
    <div>
      <p class="title" style="color: white; text-shadow: 5px 5px 5px black;">
        Panel de Administrador
      </p>
    </div>
  </div>
</section>

<div class="columns" style="margin-top: 2rem;">
  <div class="column is-2"></div>
  <div class="column">
    <div class="box">
      <h1 class="title" id="categorias">Categorias</h1>
      <TableCategorias Categorias="@Categorias" DeleteHandler="DeleteCategory" />
      <a class="button is-primary" href="/hub/categorias/registro">
        Agregar
      </a>
    </div>

    <div class="box">
      <h1 class="title" id="productos">Productos</h1>
      <TableProductos Productos="@Productos" DeleteHandler="DeleteProduct" />
      <a class="button is-primary" href="/hub/productos/registro">
        Agregar
      </a>
    </div>

    <div class="box">
      <h1 class="title" id="pedidos">Pedidos</h1>
      <TablePedidos Pedidos="@Pedidos" DeleteHandler="DeletePedido" />
      <a class="button is-primary" href="/hub/pedidos/registro">
        Agregar
      </a>
    </div>

    <div class="box">
      <h1 class="title" id="distribuidores">Distribuidores</h1>
      <!--TODO-->
    </div>

  </div>
  <div class="column is-2"></div>
</div>

<FanFooter />

<Embers.Bulma.Modal @ref="deleteDialog">
  <div class="box content has-text-centered">
    <h1>Advertencia</h1>
    <p>¿Estás seguro que deseas eliminar este elemento?</p>

    <div class="buttons">
      <button class="button is-info" @onclick="Cancel">
        Cancelar
      </button>
      <button class="button is-danger" @onclick="() => ConfirmDelete()">
        Continuar
      </button>
    </div>
  </div>
</Embers.Bulma.Modal>

@code{
  private Dropdown option;
  private Modal deleteDialog;
  private List<Categoria> Categorias;
  private List<Producto> Productos;
  private List<Distribuidor> Distribuidores;
  private List<Pedido> Pedidos;
  private Producto productoTemp;
  private Categoria categoriaTemp;
  private Distribuidor distTemp;
  private Pedido pedidoTemp;
  private void Cancel()
  {
    categoriaTemp = null;
    productoTemp = null;
    distTemp = null;
    deleteDialog.makeVisible();
  }
  private async Task ConfirmDelete()
  {
    if (productoTemp != null)
      await ProdSrv.Delete(productoTemp);
    if (categoriaTemp != null)
      await CatSrv.DeleteCategory(categoriaTemp);
    if (pedidoTemp != null)
      await MailSrv.Delete(pedidoTemp);
    
    NavMgr.NavigateTo("/hub", true);
  }
  private void DeleteProduct(Producto p)
  {
    productoTemp = p;
    deleteDialog.makeVisible();
  }
  private void DeleteCategory(Categoria p)
  {
    categoriaTemp = p;
    deleteDialog.makeVisible();
  }
  private void DeletePedido(Pedido p)
  {
    pedidoTemp = p;
    deleteDialog.makeVisible();
  }
  protected async override Task OnInitializedAsync()
  {
    await base.OnInitializedAsync();

    if (_currentUser == null)
      NavMgr.NavigateTo("/404", true);

    var c = await CatSrv.GetCategories();
    Categorias = c.ToList();

    var p = await ProdSrv.GetAll();
    Productos = p.ToList();

    var pd = await MailSrv.GetPedidos();
    Pedidos = pd.ToList();

    var d = await MailSrv.GetDistribuidores();
    Distribuidores = d.ToList();
  }
}